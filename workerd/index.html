<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>esm-compiler at edge</title>
  <style>
    textarea {
      width: 600px;
      min-height: 80px;
      padding: 4px 8px;
      field-sizing: content;
      font-family: monospace;
      border-color: #999;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <h1>ESM Compiler</h1>
  <p>Transpiles <code>JavaScript/TypeScript/CSS</code> modules at edge.</p>

  <form action="/" method="post">
    <h4>Input</h4>
    <textarea name="code">
import { useState } from "react"

export default function App() {
  const [msg] = useState<string>("world")
  return <h1>Hello {msg}!</h1>
}</textarea>

    <h4>Import Map</h4>
    <textarea name="importMap"
      oninput="try{let a=JSON.parse(value);if (!a||typeof a!=='object'||Array.isArray(a))throw 1;style.outlineColor=''}catch(e){style.outlineColor='red'}">{
  "imports": {
    "@jsxImportSource": "https://esm.sh/react@18",
    "react": "https://esm.sh/react@18"
  }
}</textarea>

    <details>
      <summary>Options</summary>
      <p>
        <label>
          Filename:
          <select name="filename">
            <option value="main.js">main.js</option>
            <option value="main.jsx">main.jsx</option>
            <option value="main.ts">main.ts</option>
            <option value="main.tsx" selected>main.tsx</option>
          </select>
        </label>
      </p>
      <p>
        <label>
          Target:
          <select name="target">
            <option value="es2015">es2015</option>
            <option value="es2016">es2016</option>
            <option value="es2017">es2017</option>
            <option value="es2018">es2018</option>
            <option value="es2019">es2019</option>
            <option value="es2020">es2020</option>
            <option value="es2021">es2021</option>
            <option value="es2022">es2022</option>
            <option value="esnext" selected>esnext</option>
          </select>
        </label>
      </p>
      <p>
        <label>
          Minify:
          <input type="checkbox" name="minify" checked>
        </label>
      </p>
      <p>
        <label>
          Keep Names:
          <input type="checkbox" name="keepNames">
        </label>
      </p>
      <p>
        <label>
          Tree Shaking:
          <input type="checkbox" name="treeShaking">
        </label>
      </p>
      <p>
        <label>
          Source Map:
          <select name="sourceMap">
            <option value="">None</option>
            <option value="inline">Inline</option>
            <option value="external" selected>External</option>
          </select>
        </label>
      </p>
    </details>

    <p>
      <button type="submit">Transform</button>
    </p>
  </form>

  <div>
    <h2 id="result_h" style="display:none">Result</h2>
    <p id="loading" style="display:none">Loading...</p>
    <code id="error" style="color:red"></code>
    <pre><code id="result"></code></pre>
  </div>

  <script>
    document.querySelector("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      loading.style.display = "block";
      result_h.style.display = "none";
      result.textContent = "";
      error.textContent = "";
      fetch("/", {
        method: "POST",
        body: JSON.stringify({
          filename: fd.get("filename"),
          code: fd.get("code"),
          target: fd.get("target"),
          importMap: JSON.parse(fd.get("importMap")),
          minify: fd.get("minify") === "on",
          keepNames: fd.get("keepNames") === "on",
          treeShaking: fd.get("treeShaking") === "on",
          sourceMap: fd.get("sourceMap"),
        })
      }).then((res) => {
        if (!res.ok) {
          return res.json().then((ret) => Promise.reject(new Error(ret.error.message)));
        }
        return res.json();
      }).then((ret) => {
        result.textContent = JSON.stringify(ret, null, 2);
        error.textContent = "";
      }).catch((err) => {
        result.textContent = "";
        error.textContent = "Error: " + err.message;
      }).finally(() => {
        loading.style.display = "none";
        result_h.style.display = "block";
      });
    });
  </script>
</body>

</html>
